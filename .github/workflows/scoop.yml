name: Scoop Distribution

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  workflow_dispatch:

jobs:
  scoop:
    name: Update Scoop Bucket
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write
      pull-requests: write
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Download release metadata
        uses: actions/download-artifact@v4
        with:
          name: release-meta
          path: release-meta
          github-token: ${{ github.token }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Read release info
        id: release
        run: |
          TAG=$(cat release-meta/tag)
          IS_PRERELEASE=$(cat release-meta/is_prerelease)
          VERSION="${TAG#v}"
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "Release: $TAG (v$VERSION), Prerelease: $IS_PRERELEASE"

      - name: Skip prerelease
        if: steps.release.outputs.is_prerelease == 'true'
        run: |
          echo "::notice::Skipping Scoop update for prerelease: ${{ steps.release.outputs.tag }}"

      - uses: actions/checkout@v4
        if: steps.release.outputs.is_prerelease != 'true'
        with:
          ref: main

      - name: Get checksum from release
        if: steps.release.outputs.is_prerelease != 'true'
        id: checksum
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          curl -L -o SHA256SUMS.txt "https://github.com/AmarBego/GitTop/releases/download/v${VERSION}/SHA256SUMS.txt"
          
          # Extract checksum for the Windows zip (format: "hash  path/to/file.zip")
          CHECKSUM=$(grep 'gittop-windows-x86_64\.zip$' SHA256SUMS.txt | cut -d' ' -f1)
          
          if [ -z "$CHECKSUM" ]; then
            echo "::error::Could not find checksum for gittop-windows-x86_64.zip in SHA256SUMS.txt"
            exit 1
          fi
          
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "Checksum: $CHECKSUM"

      - name: Update Scoop manifest
        if: steps.release.outputs.is_prerelease != 'true'
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          CHECKSUM="${{ steps.checksum.outputs.checksum }}"
          
          # Update the manifest using jq for proper JSON manipulation
          jq --arg ver "$VERSION" --arg hash "$CHECKSUM" '
            .version = $ver |
            .architecture."64bit".url = "https://github.com/AmarBego/GitTop/releases/download/v\($ver)/gittop-windows-x86_64.zip" |
            .architecture."64bit".hash = $hash
          ' bucket/gittop.json > bucket/gittop.json.tmp && mv bucket/gittop.json.tmp bucket/gittop.json
          
          echo "Updated bucket/gittop.json:"
          cat bucket/gittop.json

      - name: Create PR for Scoop update
        if: steps.release.outputs.is_prerelease != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH="scoop-update-${{ steps.release.outputs.version }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes
          git add bucket/gittop.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Create branch and push
          git checkout -b "$BRANCH"
          git commit -m "scoop: update to ${{ steps.release.outputs.tag }}"
          git push origin "$BRANCH"
          
          # Create PR
          gh pr create \
            --title "scoop: update to ${{ steps.release.outputs.tag }}" \
            --body "Automated Scoop manifest update for release ${{ steps.release.outputs.tag }}" \
            --base main \
            --head "$BRANCH"
